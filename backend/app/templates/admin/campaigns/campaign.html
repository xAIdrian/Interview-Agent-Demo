{% extends "base.html" %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Campaign: {{ campaign.title }}</h1>
<p class="mb-2">Max User Submissions: {{ campaign.max_user_submissions }}</p>
<p class="mb-4">Max Points: {{ campaign.max_points }}</p>

<h2 class="text-xl font-bold mb-4">Questions: {{ questions_count }}</h2>

<h2 class="text-xl font-bold mb-4">Submissions: {{ submissions_count }}</h2>
<div id="submissions-table" class="mb-4"></div>
<script src="https://unpkg.com/tabulator-tables@5.0.7/dist/js/tabulator.min.js"></script>
<link href="https://unpkg.com/tabulator-tables@5.0.7/dist/css/tabulator.min.css" rel="stylesheet">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var campaignId = "{{ campaign.id }}";
        console.log(campaignId);
        var table = new Tabulator("#submissions-table", {
            ajaxURL: "/api/submissions",
            ajaxParams: { campaign_id: campaignId },
            layout: "fitColumns",
            initialSort: [
                { column: "total_points", dir: "desc" }  // Sort by total points in descending order
            ],
            columns: [
                //{ title: "ID", field: "id" },
                { title: "User Email", field: "email" },
                { title: "Creation Time", field: "creation_time", editor: "input" },
                { title: "Completion Time", field: "completion_time", editor: "input" },
                { title: "Is Complete", field: "is_complete", formatter: function(cell) {
                    return cell.getValue() ? "Yes" : "No";
                }, editor: "tickCross" },
                { title: "Total Points", field: "total_points", editor: "input"},
                { title: "Actions", formatter: "link", formatterParams: {
                    label: "View",
                    url: function(cell) {
                        return "/admin/campaigns/" + campaignId + "/submissions/" + cell.getRow().getData().id;
                    }
                }}
            ],
            cellEdited: function(cell) {
                var data = cell.getRow().getData();
                fetch("/api/submissions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                }).then(response => response.json())
                  .then(data => {
                      if (data.message) {
                          alert(data.message);
                      }
                  });
            }
        });

        // Add filters
        document.getElementById('filter-user-id').addEventListener('input', function() {
            table.setFilter("user_id", "like", this.value);
        });
        document.getElementById('filter-creation-time').addEventListener('input', function() {
            table.setFilter("creation_time", "like", this.value);
        });
        document.getElementById('filter-completion-time').addEventListener('input', function() {
            table.setFilter("completion_time", "like", this.value);
        });
        document.getElementById('filter-is-complete').addEventListener('change', function() {
            table.setFilter("is_complete", "=", this.checked);
        });
        document.getElementById('filter-total-points').addEventListener('input', function() {
            table.setFilter("total_points", "like", this.value);
        });
    });
</script>
{% endblock %}