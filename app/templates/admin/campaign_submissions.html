{% extends "base.html" %}

{% block content %}
<h1>Submissions for Campaign: {{ campaign_name }}</h1>
<div id="submissions-table"></div>
<script src="https://unpkg.com/tabulator-tables@5.0.7/dist/js/tabulator.min.js"></script>
<link href="https://unpkg.com/tabulator-tables@5.0.7/dist/css/tabulator.min.css" rel="stylesheet">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var campaignId = {{ campaign_id }};
        var table = new Tabulator("#submissions-table", {
            ajaxURL: "/api/submissions",
            ajaxParams: { campaign_id: campaignId },
            layout: "fitColumns",
            columns: [
                { title: "ID", field: "id" },
                { title: "User Email", field: "email" },
                { title: "Creation Time", field: "creation_time", editor: "input" },
                { title: "Completion Time", field: "completion_time", editor: "input" },
                { title: "Is Complete", field: "is_complete", editor: "tickCross" },
                { title: "Total Points", field: "total_points", editor: "input" },
                { title: "Actions", formatter: "link", formatterParams: {
                    label: "View",
                    url: function(cell) {
                        return "{{ url_for('admin_submission_details', campaign_id=campaign_id, submission_id=0) }}".replace('0', cell.getRow().getData().id);
                    }
                }}
            ],
            cellEdited: function(cell) {
                var data = cell.getRow().getData();
                fetch("/api/submissions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data)
                }).then(response => response.json())
                  .then(data => {
                      if (data.message) {
                          alert(data.message);
                      }
                  });
            }
        });

        // Add filters
        document.getElementById('filter-user-id').addEventListener('input', function() {
            table.setFilter("user_id", "like", this.value);
        });
        document.getElementById('filter-creation-time').addEventListener('input', function() {
            table.setFilter("creation_time", "like", this.value);
        });
        document.getElementById('filter-completion-time').addEventListener('input', function() {
            table.setFilter("completion_time", "like", this.value);
        });
        document.getElementById('filter-is-complete').addEventListener('change', function() {
            table.setFilter("is_complete", "=", this.checked);
        });
        document.getElementById('filter-total-points').addEventListener('input', function() {
            table.setFilter("total_points", "like", this.value);
        });
    });
</script>
{% endblock %}