{% extends "base.html" %}
{% block content %}
<h3 class="text-2xl font-bold mb-4">Create New Campaign</h3>
<form id="create-campaign-form" class="space-y-4">
    <div class="form-group">
        <label for="title" class="block text-sm font-medium text-gray-700">Campaign Title</label>
        <input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="title" name="title" required>
    </div>
    <div class="form-group">
        <label for="max_user_submissions" class="block text-sm font-medium text-gray-700">Max User Submissions</label>
        <input type="number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="max_user_submissions" name="max_user_submissions" value="1" required>
    </div>
    <div class="form-group">
        <label for="is_public" class="block text-sm font-medium text-gray-700">Publish Immediately</label>
        <input type="checkbox" class="mt-1" id="is_public" name="is_public">
    </div>
    
    <h3 class="text-xl font-bold mb-4">Questions</h3>
    <div id="questions-container" class="space-y-4">
        <div class="question form-section">
            <div class="form-group">
                <label for="question_title_1" class="block text-sm font-medium text-gray-700">Question Title</label>
                <input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="question_title_1" name="questions[0][title]" required>
            </div>
            <div class="form-group">
                <label for="question_body_1" class="block text-sm font-medium text-gray-700">Question Body</label>
                <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="question_body_1" name="questions[0][body]" required></textarea>
            </div>
            <div class="form-group">
                <label for="scoring_prompt_1" class="block text-sm font-medium text-gray-700">Scoring Prompt</label>
                <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="scoring_prompt_1" name="questions[0][scoring_prompt]" required></textarea>
            </div>
            <div class="form-group">
                <label for="max_points_1" class="block text-sm font-medium text-gray-700">Max Points</label>
                <input type="number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="max_points_1" name="questions[0][max_points]" required>
            </div>
        </div>
    </div>
    <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700" onclick="addQuestion()">Add Another Question</button>
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">Create Campaign</button>
</form>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/3.3.2/select2.js"></script>
<script src="{{ url_for('static', filename='js/cloneData.js') }}"></script>
<script>
let questionCount = 1;

function addQuestion() {
    questionCount++;
    const questionsContainer = document.getElementById('questions-container');
    const questionDiv = document.createElement('div');
    questionDiv.classList.add('question', 'form-section');
    questionDiv.innerHTML = `
        <div class="form-group">
            <label for="question_title_${questionCount}" class="block text-sm font-medium text-gray-700">Question Title</label>
            <input type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="question_title_${questionCount}" name="questions[${questionCount - 1}][title]" required>
        </div>
        <div class="form-group">
            <label for="question_body_${questionCount}" class="block text-sm font-medium text-gray-700">Question Body</label>
            <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="question_body_${questionCount}" name="questions[${questionCount - 1}][body]" required></textarea>
        </div>
        <div class="form-group">
            <label for="scoring_prompt_${questionCount}" class="block text-sm font-medium text-gray-700">Scoring Prompt</label>
            <textarea class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="scoring_prompt_${questionCount}" name="questions[${questionCount - 1}][scoring_prompt]" required></textarea>
        </div>
        <div class="form-group">
            <label for="max_points_${questionCount}" class="block text-sm font-medium text-gray-700">Max Points</label>
            <input type="number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" id="max_points_${questionCount}" name="questions[${questionCount - 1}][max_points]" required>
        </div>
    `;
    questionsContainer.appendChild(questionDiv);
}

document.getElementById('create-campaign-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const data = {
        title: formData.get('title'),
        max_user_submissions: Number(formData.get('max_user_submissions')),
        is_public: formData.get('is_public') === 'on',
        questions: []
    };

    for (let i = 0; i < questionCount; i++) {
        data.questions.push({
            title: formData.get(`questions[${i}][title]`),
            body: formData.get(`questions[${i}][body]`),
            scoring_prompt: formData.get(`questions[${i}][scoring_prompt]`),
            max_points: Number(formData.get(`questions[${i}][max_points]`))
        });
    }

    fetch('/api/campaigns', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            window.location.href = '/admin/campaigns';
        } else {
            alert('Error creating campaign: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});
</script>
{% endblock %}